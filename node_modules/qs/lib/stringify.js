'use strict';

<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
var utils = require('./utils');
var formats = require('./formats');

var arrayPrefixGenerators = {
    brackets: function brackets(prefix) { // eslint-disable-line func-name-matching
        return prefix + '[]';
    },
    indices: function indices(prefix, key) { // eslint-disable-line func-name-matching
        return prefix + '[' + key + ']';
    },
    repeat: function repeat(prefix) { // eslint-disable-line func-name-matching
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
var Utils = require('./utils');

var arrayPrefixGenerators = {
    brackets: function brackets(prefix) {
        return prefix + '[]';
    },
    indices: function indices(prefix, key) {
        return prefix + '[' + key + ']';
    },
    repeat: function repeat(prefix) {
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
        return prefix;
    }
};

<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
var toISO = Date.prototype.toISOString;

var defaults = {
    delimiter: '&',
    encode: true,
    encoder: utils.encode,
    encodeValuesOnly: false,
    serializeDate: function serializeDate(date) { // eslint-disable-line func-name-matching
        return toISO.call(date);
    },
    skipNulls: false,
    strictNullHandling: false
};

var stringify = function stringify( // eslint-disable-line func-name-matching
    object,
    prefix,
    generateArrayPrefix,
    strictNullHandling,
    skipNulls,
    encoder,
    filter,
    sort,
    allowDots,
    serializeDate,
    formatter,
    encodeValuesOnly
) {
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
var defaults = {
    delimiter: '&',
    strictNullHandling: false,
    skipNulls: false,
    encode: true,
    encoder: Utils.encode
};

var stringify = function stringify(object, prefix, generateArrayPrefix, strictNullHandling, skipNulls, encoder, filter, sort, allowDots) {
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    var obj = object;
    if (typeof filter === 'function') {
        obj = filter(prefix, obj);
    } else if (obj instanceof Date) {
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
        obj = serializeDate(obj);
    } else if (obj === null) {
        if (strictNullHandling) {
            return encoder && !encodeValuesOnly ? encoder(prefix) : prefix;
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
        obj = obj.toISOString();
    } else if (obj === null) {
        if (strictNullHandling) {
            return encoder ? encoder(prefix) : prefix;
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
        }

        obj = '';
    }

<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean' || utils.isBuffer(obj)) {
        if (encoder) {
            var keyValue = encodeValuesOnly ? prefix : encoder(prefix);
            return [formatter(keyValue) + '=' + formatter(encoder(obj))];
        }
        return [formatter(prefix) + '=' + formatter(String(obj))];
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
    if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean' || Utils.isBuffer(obj)) {
        if (encoder) {
            return [encoder(prefix) + '=' + encoder(obj)];
        }
        return [prefix + '=' + String(obj)];
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    }

    var values = [];

    if (typeof obj === 'undefined') {
        return values;
    }

    var objKeys;
    if (Array.isArray(filter)) {
        objKeys = filter;
    } else {
        var keys = Object.keys(obj);
        objKeys = sort ? keys.sort(sort) : keys;
    }

    for (var i = 0; i < objKeys.length; ++i) {
        var key = objKeys[i];

        if (skipNulls && obj[key] === null) {
            continue;
        }

        if (Array.isArray(obj)) {
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
            values = values.concat(stringify(
                obj[key],
                generateArrayPrefix(prefix, key),
                generateArrayPrefix,
                strictNullHandling,
                skipNulls,
                encoder,
                filter,
                sort,
                allowDots,
                serializeDate,
                formatter,
                encodeValuesOnly
            ));
        } else {
            values = values.concat(stringify(
                obj[key],
                prefix + (allowDots ? '.' + key : '[' + key + ']'),
                generateArrayPrefix,
                strictNullHandling,
                skipNulls,
                encoder,
                filter,
                sort,
                allowDots,
                serializeDate,
                formatter,
                encodeValuesOnly
            ));
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
            values = values.concat(stringify(obj[key], generateArrayPrefix(prefix, key), generateArrayPrefix, strictNullHandling, skipNulls, encoder, filter, sort, allowDots));
        } else {
            values = values.concat(stringify(obj[key], prefix + (allowDots ? '.' + key : '[' + key + ']'), generateArrayPrefix, strictNullHandling, skipNulls, encoder, filter, sort, allowDots));
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
        }
    }

    return values;
};

module.exports = function (object, opts) {
    var obj = object;
    var options = opts || {};
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741

    if (options.encoder !== null && options.encoder !== undefined && typeof options.encoder !== 'function') {
        throw new TypeError('Encoder has to be a function.');
    }

<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    var delimiter = typeof options.delimiter === 'undefined' ? defaults.delimiter : options.delimiter;
    var strictNullHandling = typeof options.strictNullHandling === 'boolean' ? options.strictNullHandling : defaults.strictNullHandling;
    var skipNulls = typeof options.skipNulls === 'boolean' ? options.skipNulls : defaults.skipNulls;
    var encode = typeof options.encode === 'boolean' ? options.encode : defaults.encode;
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    var encoder = typeof options.encoder === 'function' ? options.encoder : defaults.encoder;
    var sort = typeof options.sort === 'function' ? options.sort : null;
    var allowDots = typeof options.allowDots === 'undefined' ? false : options.allowDots;
    var serializeDate = typeof options.serializeDate === 'function' ? options.serializeDate : defaults.serializeDate;
    var encodeValuesOnly = typeof options.encodeValuesOnly === 'boolean' ? options.encodeValuesOnly : defaults.encodeValuesOnly;
    if (typeof options.format === 'undefined') {
        options.format = formats.default;
    } else if (!Object.prototype.hasOwnProperty.call(formats.formatters, options.format)) {
        throw new TypeError('Unknown format option provided.');
    }
    var formatter = formats.formatters[options.format];
    var objKeys;
    var filter;

<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
    var encoder = encode ? (typeof options.encoder === 'function' ? options.encoder : defaults.encoder) : null;
    var sort = typeof options.sort === 'function' ? options.sort : null;
    var allowDots = typeof options.allowDots === 'undefined' ? false : options.allowDots;
    var objKeys;
    var filter;

    if (options.encoder !== null && options.encoder !== undefined && typeof options.encoder !== 'function') {
        throw new TypeError('Encoder has to be a function.');
    }

>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    if (typeof options.filter === 'function') {
        filter = options.filter;
        obj = filter('', obj);
    } else if (Array.isArray(options.filter)) {
<<<<<<< HEAD
        filter = options.filter;
        objKeys = filter;
=======
<<<<<<< HEAD
        filter = options.filter;
        objKeys = filter;
=======
<<<<<<< HEAD
        filter = options.filter;
        objKeys = filter;
=======
<<<<<<< HEAD
        filter = options.filter;
        objKeys = filter;
=======
        objKeys = filter = options.filter;
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    }

    var keys = [];

    if (typeof obj !== 'object' || obj === null) {
        return '';
    }

    var arrayFormat;
    if (options.arrayFormat in arrayPrefixGenerators) {
        arrayFormat = options.arrayFormat;
    } else if ('indices' in options) {
        arrayFormat = options.indices ? 'indices' : 'repeat';
    } else {
        arrayFormat = 'indices';
    }

    var generateArrayPrefix = arrayPrefixGenerators[arrayFormat];

    if (!objKeys) {
        objKeys = Object.keys(obj);
    }

    if (sort) {
        objKeys.sort(sort);
    }

    for (var i = 0; i < objKeys.length; ++i) {
        var key = objKeys[i];

        if (skipNulls && obj[key] === null) {
            continue;
        }

<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
        keys = keys.concat(stringify(
            obj[key],
            key,
            generateArrayPrefix,
            strictNullHandling,
            skipNulls,
            encode ? encoder : null,
            filter,
            sort,
            allowDots,
            serializeDate,
            formatter,
            encodeValuesOnly
        ));
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
        keys = keys.concat(stringify(obj[key], key, generateArrayPrefix, strictNullHandling, skipNulls, encoder, filter, sort, allowDots));
>>>>>>> 04021d3ff90fcfc29304fad713156bc7eed094e0
>>>>>>> 0d181195da54bd2c368194c48ad26cc82c169f9a
>>>>>>> 0458b7681f61a1a13646e680ffd1e87b47607913
>>>>>>> d558e76119e3e92dd54c9fead9e84207736a0741
    }

    return keys.join(delimiter);
};
